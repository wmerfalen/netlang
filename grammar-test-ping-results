%embed ".env"

# Every minute open connections to github.com and google.com
# on ports 80 and 443. Store results in 'uptime' postgres table

# Lambdas aren't fully supported yet.
crontab.run('* * * * *',[]() -> {
  tcp.open('github.com',80,443) |=> [pg.uptime];
  tcp.open('google.com',80,443) |=> [pg.uptime];
})

# Host the table results of uptime at /api/v1/uptime
#https.host(
#  '/api/v1/uptime',8080
#) <=| [pg.uptime]

job.define('backup-db',[]() -> {
  ssh.exec('user@dev-server','~/bin/backup-db') |=> [pg.jobs]
})
#https.protect('/api/v1/backup-db') <=| [pg.admin_sessions]
https.when('post','/api/v1/backup-db','singleton','backup-db')
